<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tabla de Puntos</title>
  <style>
    /* Tema claro (fondo blanco) */
    :root{
      --bg: #ffffff;
      --fg: #111111;
      --card: #ffffff;
      --muted: #666;
      --border: #000;
      --accent: gold;
    }
    body{
      font-family: 'Comic Sans MS','Comic Sans','Comic Neue',cursive;
      text-align:center;
      background: var(--bg);
      color: var(--fg);
      margin:0; padding:0 0 40px;
    }
    #fecha{
      font-size:24px;font-weight:bold;margin:20px auto 12px; padding:10px 14px;
      background:#f3f3f3; display:inline-block; border-radius:10px; border:1px solid #e5e5e5;
    }
    h1{font-size:32px; margin:18px 0 6px;}
    .controls{
      display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin:10px 0 8px;
    }
    .controls input[type="date"],
    .controls input[type="text"]{
      padding:8px 10px; border-radius:8px; border:1px solid #d0d0d0; font-size:16px;
    }
    .toggle{
      background:#f7f7f7; border:1px solid #e0e0e0;
      padding:6px 12px; border-radius:999px; font-size:14px; display:inline-flex; align-items:center; gap:6px;
    }
    #status{
      margin:6px 0 12px; font-size:14px; color: var(--muted);
    }
    table{
      width: 96%;
      max-width: 1200px;
      margin: auto;
      border-collapse: collapse;
      background: var(--card);
      color: var(--fg);
      font-size: 18px;
      border: 1px solid #e0e0e0;
    }
    th,td{ padding:10px; border:1px solid #d6d6d6; text-align:center; }
    thead th{ background: var(--accent); position: sticky; top: 0; }
    .brillo{ animation: brillo 1s infinite alternate; }
    @keyframes brillo{
      from{ text-shadow:0 0 4px gold, 0 0 8px #ffd; }
      to{   text-shadow:0 0 10px gold,0 0 18px #ffd; }
    }
  </style>
</head>
<body>
  <h1>Tabla de Puntos</h1>
  <div id="fecha"></div>

  <div class="controls">
    <input type="date" id="filtroFecha" onchange="render()"/>
    <input type="text" id="buscador" placeholder="Buscar alumno..." onkeyup="filtrarTabla()"/>
    <label class="toggle">
      <input type="checkbox" id="mostrarTodos" onchange="render()"/>
      Mostrar todos
    </label>
  </div>

  <div id="status">Cargando datosâ€¦</div>

  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Alumno</th>
        <th>Puntos</th>
        <th>Rango</th>
        <th>Recompensas</th>
      </tr>
    </thead>
    <tbody id="tablaPuntos">
      <tr><td colspan="5">Cargando datos...</td></tr>
    </tbody>
  </table>

  <script>
    // ========= Config =========
    const SHEET_ID = "1SWtGmXlf7WbNvUlJBDktXpDcq5OfJkHE75bH5nkxurk";
    const GID = "0"; // Cambia si tu pestaÃ±a no es la 0
    const DEBUG = true;

    // ========= Utilidades fecha =========
    function hoyISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function actualizarCabecera(){
      const opciones = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      const fechaHoy = new Date().toLocaleDateString('es-ES', opciones);
      document.getElementById("fecha").innerHTML = `ðŸ“… Hoy es: <b>${fechaHoy}</b>`;
    }
    function setStatus(msg){
      const el = document.getElementById("status");
      if(el) el.textContent = msg;
      if(DEBUG) console.log("[STATUS]", msg);
    }

    // ========= Rangos / Recompensas =========
    function obtenerRango(puntos){
      if(puntos>=90) return "ðŸŒˆðŸ”¥ Gran maestro arcoiris";
      if(puntos>=80) return "ðŸŒˆ Heroico arcoiris";
      if(puntos>=70) return "ðŸŸ ðŸ”¥ Heroico Ã©lite";
      if(puntos>=60) return "ðŸŸ¡ Heroico";
      if(puntos>=50) return "ðŸ”´ Gran Maestro";
      if(puntos>=40) return "ðŸŸ  Maestro";
      if(puntos>=30) return "ðŸŸ£ Experto";
      if(puntos>=20) return "ðŸ”µ Avanzado";
      if(puntos>=10) return "ðŸŸ¢ Trabajador";
      return "âšª Sin rango";
    }
    function obtenerRecompensas(puntos){
      const grandes = Math.floor(puntos/30);
      const pequenas = Math.floor((puntos%30)/10);
      let r = "âœ¨";
      for(let i=0;i<grandes;i++) r+="ðŸŒŸ";
      for(let i=0;i<pequenas;i++) r+="â­";
      if(puntos>=70) r+=" ðŸŒŒ";
      if(puntos>=90) r+=" ðŸŒˆ";
      return r;
    }

    // ========= Filtro UI =========
    function filtrarTabla(){
      const filtroFecha = document.getElementById("filtroFecha").value;
      const filtroNombre = document.getElementById("buscador").value.toLowerCase().trim();
      const filas = document.querySelectorAll("#tablaPuntos tr");
      filas.forEach(fila=>{
        const fecha = fila.cells[0]?.innerText || "";
        const nombre = (fila.cells[1]?.innerText || "").toLowerCase();
        const okFecha = !filtroFecha || fecha===filtroFecha;
        const okNombre = !filtroNombre || nombre.includes(filtroNombre);
        fila.style.display = (okFecha && okNombre) ? "" : "none";
      });
    }

    // ========= Parsers CSV / GViz =========
    function parseCSVtoGVizLike(csv){
      const rows = csv.split(/\r?\n/).filter(r => r.length>0).map(r=>{
        const out=[]; let cur=""; let inQ=false;
        for(let i=0;i<r.length;i++){
          const ch=r[i], nx=r[i+1];
          if(ch==='"' && nx==='"'){ cur+='"'; i++; continue; }
          if(ch==='"'){ inQ=!inQ; continue; }
          if(ch===',' && !inQ){ out.push(cur); cur=""; continue; }
          cur+=ch;
        }
        out.push(cur);
        return out;
      });
      if(rows.length===0) return { table:{ cols:[], rows:[] } };
      const cols = rows[0] || [];
      const data = rows.slice(1).map(r => ({ c: cols.map((_,i)=> ({ v: r[i]??"" })) }));
      return { table: { cols: cols.map(h=>({label:h})), rows: data } };
    }

    // ========= Lectura robusta de Sheets =========
    async function fetchGViz(){
      const tq = encodeURIComponent('select *'); // evita INVALID_QUERY
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}&tq=${tq}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`GViz HTTP ${res.status}`);
      const text = await res.text();
      const m = text.match(/setResponse\(([\s\S]+)\)\s*;?$/);
      if(!m) throw new Error("GViz: respuesta inesperada (Â¿permisos?)");
      const obj = JSON.parse(m[1]);
      if (obj.status && obj.status.toLowerCase() !== 'ok') {
        const detalle = obj.errors?.[0]?.detailed_message || obj.errors?.[0]?.message || obj.status;
        throw new Error(`GViz error: ${detalle}`);
      }
      setStatus("Cargado vÃ­a GViz");
      return obj;
    }

    async function fetchCSV(){
      // Requiere â€œCualquier persona con el enlace â†’ Lectorâ€
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`CSV HTTP ${res.status}`);
      const csv = await res.text();
      setStatus("Cargado vÃ­a CSV (export)");
      return parseCSVtoGVizLike(csv);
    }

    async function fetchPubCSV(){
      // Requiere â€œArchivo â†’ Publicar en la web â†’ Hoja actual â†’ CSVâ€
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${GID}&single=true&output=csv`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`PUB CSV HTTP ${res.status}`);
      const csv = await res.text();
      setStatus("Cargado vÃ­a CSV (Publicar en la web)");
      return parseCSVtoGVizLike(csv);
    }

    // ========= NormalizaciÃ³n de encabezados de fecha =========
    function headerToISO(h){
      if(!h) return null;
      h = String(h).trim();
      // YYYY-MM-DD / YYYY/MM/DD / YYYY.MM.DD
      let m = h.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
      if(m){
        const [_,Y,M,D] = m;
        return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
      }
      // DD/MM/YYYY (o aÃ±o de 2 dÃ­gitos)
      m = h.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if(m){
        let [_,D,M,Y] = m;
        if(Y.length===2) Y = `20${Y}`;
        return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`;
      }
      return null;
    }

    // ========= DetecciÃ³n de estructura =========
    function detectarEstructuraTablero(cols){
      const labels = cols.map(c => (c.label||"").toString().trim());
      // Columna nombre
      let idxNombre = labels.findIndex(h => /^nombre del alumno$/i.test(h));
      if(idxNombre===-1) idxNombre = labels.findIndex(h => /nombre|alumno|estudiante/i.test(h));
      if(idxNombre===-1) idxNombre = 0;
      // Fechas
      const dateCols = [];
      labels.forEach((h,i)=>{
        const iso = headerToISO(h);
        if(iso) dateCols.push({ i, label:h, iso });
      });
      return { idxNombre, dateCols };
    }

    // ========= Estado =========
    let STATE = {
      rows: [], cols: [], idxNombre: 0, dateCols: [], activeDate: null
    };

    function getCell(row, idx){
      const c = row.c?.[idx];
      if(!c) return "";
      return (c.f ?? c.v ?? "").toString().trim();
    }

    function elegirFechaActiva(){
      const input = document.getElementById("filtroFecha");
      const solicitadaISO = input.value; // <input type="date"> usa ISO

      const idx = STATE.dateCols.findIndex(dc => dc.iso === solicitadaISO);
      if(idx !== -1){
        STATE.activeDate = solicitadaISO;
        return;
      }
      if(STATE.dateCols.length){
        const latest = STATE.dateCols.map(dc=>dc.iso).sort().at(-1);
        STATE.activeDate = latest;
        input.value = latest;
        return;
      }
      STATE.activeDate = "";
      input.value = "";
    }

    function render(){
      const tabla = document.getElementById("tablaPuntos");
      tabla.innerHTML = "";

      if(!STATE.rows.length){
        tabla.innerHTML = `<tr><td colspan="5">No hay datos</td></tr>`;
        return;
      }
      elegirFechaActiva();

      if(!STATE.activeDate){
        tabla.innerHTML = `<tr><td colspan="5">No hay columnas de fecha (YYYY-MM-DD) en la hoja.</td></tr>`;
        return;
      }

      const target = STATE.dateCols.find(dc => dc.iso === STATE.activeDate);
      if(!target){
        tabla.innerHTML = `<tr><td colspan="5">No se encontrÃ³ la columna de la fecha seleccionada.</td></tr>`;
        return;
      }
      const idxFechaCol = target.i;

      const showAll = document.getElementById("mostrarTodos")?.checked;

      const items = [];
      for(const r of STATE.rows){
        const nombre = getCell(r, STATE.idxNombre) || "Alumno";
        if(!nombre) continue;
        let puntosRaw = getCell(r, idxFechaCol);
        let puntos = parseInt(String(puntosRaw).replace(/[^\d-]/g,""),10);
        if(Number.isNaN(puntos)) puntos = 0;

        if(puntos > 0 || showAll){
          items.push({ nombre, puntos });
        }
      }

      items.sort((a,b)=> b.puntos - a.puntos || a.nombre.localeCompare(b.nombre));

      if(items.length===0){
        const msg = `No hay alumnos para ${STATE.activeDate}.`;
        tabla.innerHTML = `<tr><td colspan="5">${msg}</td></tr>`;
        return;
      }

      for(const {nombre, puntos} of items){
        const rango = obtenerRango(puntos);
        const recompensa = obtenerRecompensas(puntos);
        tabla.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${STATE.activeDate}</td>
            <td>${nombre}</td>
            <td>${puntos}</td>
            <td class="brillo">${rango}</td>
            <td class="brillo">${recompensa}</td>
          </tr>
        `);
      }

      filtrarTabla();
    }

    async function cargar(){
      actualizarCabecera();
      document.getElementById("filtroFecha").value = hoyISO();
      const tabla = document.getElementById("tablaPuntos");
      tabla.innerHTML = `<tr><td colspan="5">Cargando datos...</td></tr>`;

      try{
        let data;
        try{
          data = await fetchGViz();                 // 1) GViz
        }catch(e1){
          console.warn("GViz fallÃ³, probando CSV exportâ€¦", e1);
          try{
            data = await fetchCSV();                // 2) export CSV
          }catch(e2){
            console.warn("CSV export fallÃ³, probando Publicar en la web CSVâ€¦", e2);
            data = await fetchPubCSV();             // 3) publish-to-web CSV
          }
        }

        const cols = data.table?.cols || [];
        const rows = data.table?.rows || [];
        if(!rows.length){
          setStatus("Sin filas en la hoja.");
          tabla.innerHTML = `<tr><td colspan="5">Sin filas en la hoja.</td></tr>`;
          return;
        }

        const { idxNombre, dateCols } = detectarEstructuraTablero(cols);
        STATE.rows = rows;
        STATE.cols = cols;
        STATE.idxNombre = idxNombre;
        STATE.dateCols = dateCols;

        if(!dateCols.length){
          setStatus("No se detectaron columnas de fecha. AsegÃºrate de que los encabezados de fechas sean tipo 2025-11-04 o 04/11/2025.");
        }

        render();

      }catch(err){
        console.error(err);
        setStatus("Error al cargar datos (Â¿permisos/gid?). Comparte como 'Cualquiera con el enlace â†’ Lector' o 'Publicar en la web'.");
        tabla.innerHTML = `<tr><td colspan="5">
          Error al cargar datos.<br>
          1) Comprueba permisos: <b>Compartir â†’ Cualquiera con el enlace â†’ Lector</b>.<br>
          2) (Opcional) <b>Archivo â†’ Publicar en la web â†’ Hoja actual â†’ CSV</b>.<br>
          3) Verifica que el <b>gid=${GID}</b> coincida con la pestaÃ±a correcta.
        </td></tr>`;
      }
    }

    // Go!
    cargar();
  </script>
</body>
</html>
