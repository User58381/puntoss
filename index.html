<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tabla de Puntos</title>
<style>
  body{font-family:"Comic Sans MS","Comic Sans","Comic Neue",cursive;background:#fff;color:#111;margin:0;text-align:center}
  h1{margin:18px 0 6px;font-size:32px}
  #fecha{margin:16px auto 10px;padding:8px 12px;border:1px solid #e5e5e5;border-radius:10px;background:#f7f7f7;font-weight:bold}
  .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:8px 0}
  .controls input{padding:8px 10px;border:1px solid #d0d0d0;border-radius:8px}
  .toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e0e0e0;border-radius:999px;background:#fafafa}
  #status{font-size:14px;color:#666;margin:6px 0 12px}
  table{width:96%;max-width:1200px;margin:auto;border-collapse:collapse;border:1px solid #e0e0e0;background:#fff}
  th,td{border:1px solid #d6d6d6;padding:10px;text-align:center}
  thead th{background:gold;position:sticky;top:0}
</style>
</head>
<body>
  <h1>Tabla de Puntos</h1>
  <div id="fecha"></div>
  <div class="controls">
    <input type="date" id="filtroFecha" onchange="render()"/>
    <input type="text" id="buscador" placeholder="Buscar alumno..." onkeyup="filtrarTabla()"/>
    <label class="toggle"><input type="checkbox" id="mostrarTodos" onchange="render()"/>Mostrar todos</label>
  </div>
  <div id="status">Cargando datosâ€¦</div>
  <table>
    <thead><tr><th>Fecha</th><th>Alumno</th><th>Puntos</th><th>Rango</th><th>Recompensas</th></tr></thead>
    <tbody id="tablaPuntos"><tr><td colspan="5">Cargandoâ€¦</td></tr></tbody>
  </table>

<script>
const SHEET_ID="1SWtGmXlf7WbNvUlJBDktXpDcq5OfJkHE75bH5nkxurk";
const GID="0";

function setStatus(t){ const el=document.getElementById("status"); if(el) el.textContent=t; console.log("[STATUS]",t); }
function hoyISO(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` }
function actualizarCabecera(){ document.getElementById("fecha").innerHTML=`ðŸ“… Hoy es: <b>${new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</b>` }
function obtenerRango(p){ if(p>=90)return"ðŸŒˆðŸ”¥ Gran maestro arcoiris"; if(p>=80)return"ðŸŒˆ Heroico arcoiris"; if(p>=70)return"ðŸŸ ðŸ”¥ Heroico Ã©lite"; if(p>=60)return"ðŸŸ¡ Heroico"; if(p>=50)return"ðŸ”´ Gran Maestro"; if(p>=40)return"ðŸŸ  Maestro"; if(p>=30)return"ðŸŸ£ Experto"; if(p>=20)return"ðŸ”µ Avanzado"; if(p>=10)return"ðŸŸ¢ Trabajador"; return"âšª Sin rango" }
function obtenerRecompensas(p){ const G=Math.floor(p/30), S=Math.floor((p%30)/10); let r="âœ¨"; for(let i=0;i<G;i++)r+="ðŸŒŸ"; for(let i=0;i<S;i++)r+="â­"; if(p>=70)r+=" ðŸŒŒ"; if(p>=90)r+=" ðŸŒˆ"; return r }
function filtrarTabla(){ const f=document.getElementById("filtroFecha").value, n=(document.getElementById("buscador").value||"").toLowerCase().trim(); document.querySelectorAll("#tablaPuntos tr").forEach(tr=>{ const F=tr.cells[0]?.innerText||"", N=(tr.cells[1]?.innerText||"").toLowerCase(); tr.style.display=(!f||F===f) && (!n||N.includes(n)) ? "" : "none"; }); }

function headerToISO(h){
  if(!h) return null; h=String(h).trim();
  let m=h.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/); if(m){const[_,Y,M,D]=m; return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`}
  m=h.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/); if(m){let[_,D,M,Y]=m; if(Y.length===2)Y=`20${Y}`; return `${Y}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`}
  return null
}
function getCell(row,idx){ const c=row.c?.[idx]; return c ? (c.f ?? (typeof c.v==="string"?c.v:String(c.v??""))).toString().trim() : "" }
function getCellRaw(row,idx){ const c=row.c?.[idx]; return c ? c.v : null }

/* === Detecta si la PRIMERA FILA es encabezado real (con fechas) === */
function detectHeaderRow(data){
  const rows=data.table?.rows||[], cols=data.table?.cols||[];
  if(!rows.length) return {headerRowIdx:-1, labelsFrom:"cols"};

  // 0) Si cols ya traen labels con texto Ãºtil, Ãºsalo
  const colLabels=cols.map(c=>(c.label||"").trim());
  const hasAnyLabel=colLabels.some(l=>l);
  // 1) Â¿La fila 0 parece encabezado? (contiene 'Nombre del alumno' o varias celdas con fecha)
  const r0=rows[0];
  const c0=(getCell(r0,0)||"").toLowerCase();
  let fechaCount=0;
  for(let i=0;i<cols.length;i++){
    const v=getCell(r0,i);
    const raw=getCellRaw(r0,i);
    const iso = headerToISO(v) || (typeof raw==="number" && (data.table.cols[i]?.pattern||"").includes("yyyy") ? (getCell(r0,i)) : null) || (typeof raw==="string" && raw.startsWith("Date(") ? (getCell(r0,i)) : null);
    if(iso) fechaCount++;
  }
  const r0IsHeader = c0.includes("nombre") || fechaCount>=2;

  if(r0IsHeader) return {headerRowIdx:0, labelsFrom:"row"};
  if(hasAnyLabel) return {headerRowIdx:-1, labelsFrom:"cols"};

  // 2) Fallback: si no hay labels y la fila 0 no convenciÃ³, intenta fila 1
  if(rows.length>1){
    const r1=rows[1];
    const c1=(getCell(r1,0)||"").toLowerCase();
    let f1=0;
    for(let i=0;i<cols.length;i++){
      const v=getCell(r1,i), raw=getCellRaw(r1,i);
      const iso = headerToISO(v) || (typeof raw==="number" && (data.table.cols[i]?.pattern||"").includes("yyyy") ? (getCell(r1,i)) : null) || (typeof raw==="string" && raw.startsWith("Date(") ? (getCell(r1,i)) : null);
      if(iso) f1++;
    }
    if(c1.includes("nombre") || f1>=2) return {headerRowIdx:1, labelsFrom:"row"};
  }
  // Ãšltimo recurso
  return {headerRowIdx:-1, labelsFrom:"cols"};
}

/* === Estructura: nombre + fechas === */
function detectarEstructura(data){
  const rows=data.table?.rows||[], cols=data.table?.cols||[];
  const {headerRowIdx, labelsFrom}=detectHeaderRow(data);

  let labels=[], dataStart=0;
  if(labelsFrom==="row" && headerRowIdx>=0){
    labels = cols.map((_,i)=> getCell(rows[headerRowIdx], i));
    dataStart = headerRowIdx+1; // omite la fila-encabezado
  }else{
    labels = cols.map(c=>(c.label||"").toString().trim());
    dataStart = 0;
  }

  // idx nombre
  let idxNombre = labels.findIndex(h=>/^nombre del alumno$/i.test(h||""));
  if(idxNombre===-1) idxNombre = labels.findIndex(h=>/(^|\s)(nombre|alumno|estudiante)(\s|$)/i.test(h||""));
  if(idxNombre===-1) idxNombre = 0;

  // columnas de fecha: por label, o por la celda del encabezado (row header) o por meta de la col
  const dateCols=[];
  for(let i=0;i<cols.length;i++){
    let iso = headerToISO(labels[i]||"");
    if(!iso && labelsFrom==="row" && headerRowIdx>=0){
      const vHead = getCell(rows[headerRowIdx], i);
      const rawHead= getCellRaw(rows[headerRowIdx], i);
      iso = headerToISO(vHead);
      // Si es tipo date/serial con 'f', toma el formateado:
      if(!iso){
        const pat = (data.table.cols[i]?.pattern||"");
        if(typeof rawHead==="number" && pat.includes("yyyy")) iso = (getCell(rows[headerRowIdx], i)); // ya viene como f:"2025-10-03"
        if(typeof rawHead==="string" && rawHead.startsWith("Date(")){
          // f suele traer "yyyy-mm-dd"
          const f = getCell(rows[headerRowIdx], i);
          iso = headerToISO(f)||f;
        }
      }
    }
    if(iso) dateCols.push({i, iso});
  }

  return { idxNombre, dateCols, dataStart };
}

let STATE={ rows:[], idxNombre:0, dateCols:[], activeDate:null };

function elegirFechaActiva(){
  const input=document.getElementById("filtroFecha");
  const want=input.value;
  const hit=STATE.dateCols.find(dc=>dc.iso===want);
  if(hit){ STATE.activeDate=want; return; }
  if(STATE.dateCols.length){
    const latest=STATE.dateCols.map(dc=>dc.iso).sort().at(-1);
    STATE.activeDate=latest; input.value=latest; return;
  }
  STATE.activeDate=""; input.value="";
}

function render(){
  const tbody=document.getElementById("tablaPuntos"); tbody.innerHTML="";
  if(!STATE.rows.length){ tbody.innerHTML=`<tr><td colspan="5">No hay datos</td></tr>`; return }
  elegirFechaActiva();
  if(!STATE.activeDate){ tbody.innerHTML=`<tr><td colspan="5">No hay columnas de fecha (YYYY-MM-DD)</td></tr>`; return }
  const target=STATE.dateCols.find(dc=>dc.iso===STATE.activeDate);
  if(!target){ tbody.innerHTML=`<tr><td colspan="5">No se encontrÃ³ la fecha seleccionada</td></tr>`; return }
  const idxFechaCol=target.i, showAll=document.getElementById("mostrarTodos")?.checked;
  const items=[];
  for(const r of STATE.rows){
    const nombre = getCell(r, STATE.idxNombre)||"Alumno";
    if(!nombre) continue;
    let puntos = parseInt(String(getCell(r, idxFechaCol)).replace(/[^\d-]/g,""),10);
    if(Number.isNaN(puntos)) puntos=0;
    if(puntos>0 || showAll) items.push({nombre,puntos});
  }
  items.sort((a,b)=> b.puntos-a.puntos || a.nombre.localeCompare(b.nombre));
  if(!items.length){ tbody.innerHTML=`<tr><td colspan="5">No hay alumnos para ${STATE.activeDate}</td></tr>`; return }
  for(const {nombre,puntos} of items){
    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${STATE.activeDate}</td>
        <td>${nombre}</td>
        <td>${puntos}</td>
        <td>${obtenerRango(puntos)}</td>
        <td>${obtenerRecompensas(puntos)}</td>
      </tr>`);
  }
  filtrarTabla();
}

/* === GViz JSONP (sin CORS) + CSV export + CSV publicado === */
function parseCSVtoGVizLike(csv){
  const rows=csv.split(/\r?\n/).filter(Boolean).map(r=>{const out=[];let cur="",q=false;for(let i=0;i<r.length;i++){const ch=r[i],nx=r[i+1]; if(ch=='"'&&nx=='"'){cur+='"';i++;continue} if(ch=='"'){q=!q;continue} if(ch==','&&!q){out.push(cur);cur="";continue} cur+=ch} out.push(cur); return out});
  if(!rows.length) return {table:{cols:[],rows:[]}}; const cols=rows[0]; const data=rows.slice(1).map(r=>({ c: cols.map((_,i)=>({ v:r[i]??"" })) }));
  return {table:{ cols: cols.map(h=>({label:h})), rows:data }};
}
function fetchGVizJSONP(){
  return new Promise((resolve,reject)=>{
    const tq=encodeURIComponent('select *');
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json&tq=${tq}`;
    window.google=window.google||{}; window.google.visualization=window.google.visualization||{};
    const old=window.google.visualization.Query?.setResponse;
    window.google.visualization.Query=window.google.visualization.Query||{};
    window.google.visualization.Query.setResponse=function(obj){
      try{
        if(obj.status && obj.status.toLowerCase()!=='ok'){
          const e=obj.errors?.[0]?.detailed_message||obj.errors?.[0]?.message||obj.status; reject(new Error("GViz error: "+e));
        } else { setStatus("Cargado vÃ­a GViz (JSONP)"); resolve(obj); }
      } finally { if(old) window.google.visualization.Query.setResponse=old; }
    };
    const s=document.createElement("script"); s.src=url; s.async=true;
    s.onerror=()=>{ if(old) window.google.visualization.Query.setResponse=old; reject(new Error("GViz JSONP onerror (Â¿permisos?)")) };
    document.head.appendChild(s);
    setTimeout(()=>{ if(window.google.visualization.Query.setResponse===old) return; window.google.visualization.Query.setResponse=old; reject(new Error("GViz JSONP timeout")); },8000);
  });
}
async function fetchCSV(){ const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`; const r=await fetch(url,{mode:'cors'}); if(!r.ok) throw new Error("CSV HTTP "+r.status); setStatus("Cargado vÃ­a CSV (export)"); return parseCSVtoGVizLike(await r.text()); }
async function fetchPubCSV(){ const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${GID}&single=true&output=csv`; const r=await fetch(url,{mode:'cors'}); if(!r.ok) throw new Error("PUB CSV HTTP "+r.status); setStatus("Cargado vÃ­a CSV (Publicar en la web)"); return parseCSVtoGVizLike(await r.text()); }

async function cargar(){
  actualizarCabecera();
  document.getElementById("filtroFecha").value=hoyISO();
  const tbody=document.getElementById("tablaPuntos"); tbody.innerHTML=`<tr><td colspan="5">Cargandoâ€¦</td></tr>`;
  try{
    let data;
    try{ data=await fetchGVizJSONP(); }
    catch(e1){ console.warn("GViz JSONP fallÃ³ â†’ CSV export", e1);
      try{ data=await fetchCSV(); }
      catch(e2){ console.warn("CSV export fallÃ³ â†’ CSV publicar", e2);
        data=await fetchPubCSV();
      }
    }
    const det=detectarEstructura(data);
    const allRows=data.table?.rows||[];
    STATE.rows = (det.dataStart>0) ? allRows.slice(det.dataStart) : allRows;
    STATE.idxNombre = det.idxNombre;
    STATE.dateCols  = det.dateCols;

    if(!STATE.rows.length) { setStatus("Sin filas en la hoja."); tbody.innerHTML=`<tr><td colspan="5">Sin filas</td></tr>`; return; }
    if(!STATE.dateCols.length){ setStatus("No hay encabezados de fecha vÃ¡lidos. Usa 2025-11-04 o 04/11/2025 en la fila de encabezado."); }

    render();
  }catch(err){
    console.error(err);
    setStatus("Error al cargar (permisos/gid). Comparte como 'Cualquiera con el enlace â†’ Lector' o usa 'Publicar en la web'.");
    tbody.innerHTML=`<tr><td colspan="5">Error de carga. Revisa permisos y gid=${GID}.</td></tr>`;
  }
}

cargar();
</script>
</body>
</html>
